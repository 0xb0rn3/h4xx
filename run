#!/usr/bin/env bash

# Script to install Kali Linux tool categories via metapackages
# For educational and security research purposes only
# Must be run as root

# Error handling function
handle_error() {
    echo "Error: $1"
    exit 1
}

# Check root privileges
if [ "$EUID" -ne 0 ]; then 
    handle_error "Please run as root"
fi

# Verify Debian-based system
if [ ! -f "/etc/debian_version" ]; then
    handle_error "This script is for Debian-based systems only"
fi

# Backup the current sources list
echo "Creating backup of sources.list..."
cp /etc/apt/sources.list /etc/apt/sources.list.backup || handle_error "Failed to backup sources.list"

# Add Kali repository
echo "Adding Kali repository..."
echo "deb http://http.kali.org/kali kali-rolling main contrib non-free" >> /etc/apt/sources.list

# Import Kali GPG key
echo "Importing Kali GPG key..."
wget -q -O - https://archive.kali.org/archive-key.asc | apt-key add - || handle_error "Failed to import Kali GPG key"

# Update package lists
echo "Updating package lists..."
apt-get update || handle_error "Failed to update package lists"

# Install kernel headers
echo "Installing kernel headers..."
apt-get install -y linux-headers-$(uname -r) || handle_error "Failed to install kernel headers"

# Array of Kali Linux category metapackages
declare -a categories=(
    "kali-tools-information-gathering"
    "kali-tools-vulnerability"
    "kali-tools-web"
    "kali-tools-database"
    "kali-tools-passwords"
    "kali-tools-wireless"
    "kali-tools-reverse-engineering"
    "kali-tools-exploitation"
    "kali-tools-social-engineering"
    "kali-tools-sniffing-spoofing"
    "kali-tools-post-exploitation"
    "kali-tools-forensics"
    "kali-tools-reporting"
    "kali-tools-crypto-stego"
    "kali-tools-hardware"
    "kali-tools-fuzzing"
)

# Install each category package
echo "Installing Kali Linux tool categories..."
for category in "${categories[@]}"; do
    echo "Installing category: $category"
    DEBIAN_FRONTEND=noninteractive apt-get install -y "$category" || echo "Note: Failed to install $category"
    echo "----------------------------------------"
done

# System cleanup
echo "Performing system cleanup..."
apt-get autoremove -y
apt-get clean

# Create documentation
echo "Creating installation record..."
cat > /root/kali_categories_installed.txt << EOF
Kali Linux Category Packages Installation Report
Installation Date: $(date)
Original sources.list backup: /etc/apt/sources.list.backup

Installed Categories:
$(printf '%s\n' "${categories[@]}")

Note: These packages are for security research and educational purposes only.
Use responsibly and only on systems you own or have permission to test.
EOF

echo "Installation complete! Check /root/kali_categories_installed.txt for details."
echo "WARNING: These tools should only be used on systems you own or have explicit permission to test."
